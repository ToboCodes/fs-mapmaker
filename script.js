// Set map area and center view
const coord1 = [-39.603457,-73.038868];
const coord2 = [-39.808016,-72.774131];
let view = [-39.66123,-72.95155];

// Create map and set OSM tiles
let map = L.map('map', {
  maxZoom: 19,
  minZoom: 15,
  maxBounds: [
    coord1,
    coord2
  ],
}).setView(view, 16);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
}).addTo(map);


// ckpunmep's Get coordinates by click on a map + Furqan Anas' Leaflet Draggable Marker
// let markerId = 0;
map.on('click', function(e) {
  let Lat = e.latlng.lat;
  let Lng = e.latlng.lng;
  let curLocation = [Lat, Lng];
  let marker = new L.marker(curLocation, {
    draggable: 'true'
  });
  map.addLayer(marker);

  // markerId += 1;
  // console.log("Added marker " + markerId);
  // console.log(Lat.toFixed(5) + "," + Lng.toFixed(5));

  marker.on('dragend', function(event) {
    let position = marker.getLatLng();
    marker.setLatLng(position, {
      draggable: 'true'
    }).bindPopup(position).update();
    Lat = position.lat;
    Lng = position.lng;
    console.log(Lat.toFixed(5) + "," + Lng.toFixed(5));
  });
});


// Set custom zones
const territorios = {
  zone1A: [[-39.66640,-72.95407], [-39.66638,-72.95283], [-39.66755,-72.95274], [-39.66758,-72.95401]],
  zone1B: [[-39.66765,-72.95401], [-39.66761,-72.95273], [-39.66849,-72.95269], [-39.66853,-72.95399]],
  zone1C: [[-39.66859,-72.95399], [-39.66856,-72.95269], [-39.66905,-72.95267], [-39.66908,-72.95399]],
  zone1D: [[-39.66914,-72.95399], [-39.66911,-72.95267], [-39.66959,-72.95264], [-39.66962,-72.95399]],
  zone2A: [[-39.66642,-72.95788], [-39.66646,-72.95777], [-39.66649,-72.95763], [-39.66646,-72.95618],
  [-39.66657,-72.95619], [-39.66663,-72.95648], [-39.66666,-72.95778]],
  zone2B: [[-39.66594,-72.95792], [-39.66619,-72.95784], [-39.66629,-72.95778], [-39.66633,-72.95771],
  [-39.66635,-72.95760], [-39.66628,-72.95421], [-39.66566,-72.95420], [-39.66522,-72.95384],
  [-39.66522,-72.95432], [-39.66567,-72.95467], [-39.66588,-72.95467]],
  zone2C: [[-39.66728,-72.95412], [-39.66791,-72.95410], [-39.66838,-72.95429], [-39.66838,-72.95466],
  [-39.66791,-72.95454], [-39.66729,-72.95453]],
  zone2D: [[-39.66841,-72.95430], [-39.67018,-72.95499], [-39.67051,-72.95474], [-39.67048,-72.95466],
  [-39.67018,-72.95487], [-39.66811,-72.95408], [-39.66990,-72.95407], [-39.66991,-72.95445],
  [-39.67017,-72.95455], [-39.67051,-72.95426], [-39.67080,-72.95485], [-39.67017,-72.95532],
  [-39.66841,-72.95467]],
  zone2E: [[-39.66969,-72.95398], [-39.66967,-72.95264], [-39.66992,-72.95263], [-39.66994,-72.95370],
  [-39.67021,-72.95384], [-39.67021,-72.95412], [-39.66995,-72.95398]],
  zone3A: [[-39.66638,-72.95273], [-39.66637,-72.95144], [-39.66753,-72.95122], [-39.66754,-72.95264]],
  zone3B: [[-39.66762,-72.95264], [-39.66761,-72.95120], [-39.66842,-72.95108], [-39.66846,-72.95177],
  [-39.66805,-72.95178], [-39.66805,-72.95187], [-39.66846,-72.95187], [-39.66848,-72.95259]],
  zone3C: [[-39.66856,-72.95258], [-39.66855,-72.95222], [-39.66921,-72.95216], [-39.66921,-72.95205],
  [-39.66855,-72.95211], [-39.66854,-72.95168], [-39.66896,-72.95164], [-39.66955,-72.95227],
  [-39.66958,-72.95236], [-39.66958,-72.95253]],
  zone4A: [[-39.66637,-72.95133], [-39.66635,-72.95003], [-39.66718,-72.94965], [-39.66751,-72.95111]],
  zone4B: [[-39.66760,-72.95109], [-39.66750,-72.95064], [-39.66776,-72.95050], [-39.66785,-72.95074],
  [-39.66792,-72.95070], [-39.66781,-72.95039], [-39.66759,-72.94975], [-39.66754,-72.94979],
  [-39.66773,-72.95039], [-39.66748,-72.95054], [-39.66727,-72.94960], [-39.66751,-72.94949],
  [-39.66775,-72.94933], [-39.66804,-72.94987], [-39.66839,-72.95098]],
  zone4C: [[-39.66783,-72.94925], [-39.66837,-72.94866], [-39.66899,-72.94760], [-39.66939,-72.94794],
  [-39.66876,-72.94909], [-39.66814,-72.94982]],
  zone5A: [[-39.66335,-72.95147], [-39.66413,-72.95109], [-39.66414,-72.95281], [-39.66386,-72.95282],
  [-39.66386,-72.95161], [-39.66336,-72.95187]],
  zone5B: [[-39.66426,-72.95274], [-39.66426,-72.95225], [-39.66511,-72.95196], [-39.66511,-72.95279],
  [-39.66434,-72.95281], [-39.66429,-72.95279]],
  zone5C: [[-39.66426,-72.95213], [-39.66425,-72.95103], [-39.66512,-72.95063], [-39.66511,-72.95184]],
  zone5D: [[-39.66525,-72.95057], [-39.66624,-72.95010], [-39.66625,-72.95136], [-39.66523,-72.95179]],
  zone6A: [[-39.66477,-72.96084], [-39.66518,-72.96068], [-39.66548,-72.96159], [-39.66556,-72.96155],
  [-39.66527,-72.96065], [-39.66625,-72.96032], [-39.66622,-72.96021], [-39.66566,-72.96040],
  [-39.66553,-72.95988], [-39.66648,-72.95953], [-39.66669,-72.96053], [-39.66573,-72.96092],
  [-39.66590,-72.96153], [-39.66514,-72.96193]],
  zone6B: [[-39.66385,-72.96106], [-39.66373,-72.96070], [-39.66377,-72.96056], [-39.66375,-72.96043],
  [-39.66417,-72.96025], [-39.66414,-72.96013], [-39.66362,-72.96036], [-39.66318,-72.95906],
  [-39.66525,-72.95838], [-39.66539,-72.95912], [-39.66433,-72.95958], [-39.66460,-72.96042],
  [-39.66425,-72.96057], [-39.66434,-72.96085]],
  zone6C: [[-39.66590,-72.95793], [-39.66312,-72.95888], [-39.66248,-72.95714], [-39.66273,-72.95696],
  [-39.66328,-72.95845], [-39.66588,-72.95748]],
  zone7A: [[-39.66240,-72.95691], [-39.66323,-72.95619], [-39.66335,-72.95602], [-39.66458,-72.95491],
  [-39.66468,-72.95509], [-39.66345,-72.95623], [-39.66333,-72.95642], [-39.66247,-72.95711]],
  zone7B: [[-39.66363,-72.95563], [-39.66326,-72.95497], [-39.66348,-72.95478], [-39.66384,-72.95544]],
  zone7C: [[-39.66390,-72.95539], [-39.66374,-72.95509], [-39.66422,-72.95466], [-39.66430,-72.95479],
  [-39.66443,-72.95466], [-39.66452,-72.95482]],
  zone7D: [[-39.66370,-72.95501], [-39.66354,-72.95471], [-39.66376,-72.95452], [-39.66384,-72.95465],
  [-39.66398,-72.95452], [-39.66407,-72.95467]],
  zone7E: [[-39.66318,-72.95493], [-39.66307,-72.95472], [-39.66358,-72.95424], [-39.66371,-72.95445]],
  zone8A: [[-39.66257,-72.95663], [-39.66220,-72.95592], [-39.66240,-72.95574], [-39.66278,-72.95645]],
  zone8B: [[-39.66284,-72.95640], [-39.66246,-72.95569], [-39.66266,-72.95551], [-39.66304,-72.95622]],
  zone8C: [[-39.66311,-72.95617], [-39.66272,-72.95546], [-39.66293,-72.95528], [-39.66329,-72.95595],
  [-39.66318,-72.95610]],
  zone8D: [[-39.66335,-72.95589], [-39.66300,-72.95521], [-39.66319,-72.95504], [-39.66356,-72.95570]],
  zone8E: [[-39.66224,-72.95576], [-39.66213,-72.95555], [-39.66258,-72.95514], [-39.66269,-72.95535]],
  zone9A: [[-39.66127,-72.95961], [-39.66157,-72.96070], [-39.66145,-72.96076], [-39.66115,-72.95966]],
  zone9B: [[-39.66245,-72.95933], [-39.66302,-72.95913], [-39.66317,-72.95957], [-39.66259,-72.95978]],
  zone9C: [[-39.66003,-72.95960], [-39.66016,-72.95957], [-39.66074,-72.95951], [-39.66241,-72.95912],
  [-39.66295,-72.95894], [-39.66255,-72.95779], [-39.66185,-72.95817], [-39.66202,-72.95858],
  [-39.66060,-72.95888], [-39.65998,-72.95906]],
  zone9D: [[-39.66058,-72.95875], [-39.66185,-72.95849], [-39.66170,-72.95811], [-39.66250,-72.95765],
  [-39.66226,-72.95696], [-39.66197,-72.95715], [-39.66211,-72.95754], [-39.66135,-72.95797],
  [-39.66147,-72.95825], [-39.66053,-72.95843]],
  zone9E: [[-39.66117,-72.95647], [-39.66190,-72.95591], [-39.66203,-72.95631], [-39.66131,-72.95682]],
  zone9F: [[-39.66113,-72.95635], [-39.66188,-72.95581], [-39.66185,-72.95550], [-39.66186,-72.95531],
  [-39.66198,-72.95405], [-39.66156,-72.95428], [-39.66144,-72.95565], [-39.66100,-72.95598]],
  zone9G: [[-39.66223,-72.95186], [-39.66161,-72.95166], [-39.65873,-72.95223], [-39.65919,-72.95328],
  [-39.66213,-72.95271]],
  zone9H: [[-39.65789,-72.95242], [-39.65862,-72.95226], [-39.65924,-72.95366], [-39.65900,-72.95388],
  [-39.65846,-72.95268], [-39.65805,-72.95277], [-39.65794,-72.95259]],
  zone10A: [[-39.66245,-72.95026], [-39.66113,-72.95073], [-39.66097,-72.95072], [-39.66081,-72.95068],
  [-39.66059,-72.95055], [-39.66039,-72.95036], [-39.66019,-72.95005], [-39.66045,-72.94987],
  [-39.66063,-72.95019], [-39.66085,-72.95032], [-39.66110,-72.95037], [-39.66230,-72.94988],
  [-39.66242,-72.95017]],
  zone10B: [[-39.66205,-72.94932], [-39.66124,-72.94991], [-39.66121,-72.94983], [-39.66202,-72.94923],
  [-39.66191,-72.94897], [-39.66108,-72.94959], [-39.66105,-72.94951], [-39.66187,-72.94889],
  [-39.66159,-72.94829], [-39.66131,-72.94852], [-39.66151,-72.94900], [-39.66144,-72.94905],
  [-39.66123,-72.94857], [-39.66102,-72.94872], [-39.66123,-72.94918], [-39.66116,-72.94923],
  [-39.66095,-72.94877], [-39.66069,-72.94895], [-39.66058,-72.94904], [-39.66081,-72.94958],
  [-39.66049,-72.94983], [-39.66057,-72.95000], [-39.66089,-72.94977], [-39.66112,-72.95032],
  [-39.66218,-72.94962]]
}

// Set zone colors
const colors = {
1: "#FE80A9", 2: "#FCAA0C", 3: "#FE7F26", 4: "#B3A2E6", 5: "#DA0022", 6: "#888888",
7: "#20B250", 8: "#5CF4F1", 9: "#77CDE8", 10: "#FD76B8", 11: "#C00000", 12: "#90E7B4",
13: "#EFE4AF", 14: "#FFF86E", 15: "#E65B00", 16: "#92914A",
17: "#EF00F1", 18: "#FF3E3D"
}

// Place custom zones
function createZones(obj, col) {
  for (let i in obj) {
      let num = i.match(/\d+/)[0];
      L.polygon(obj[i], {color: col[num], fillOpacity: 0.7, weight: 2}).addTo(map);
  }
}

createZones(territorios, colors)

// Set zone and square markers
markers = {
  num: [[-39.66697,-72.95340], [-39.66785,-72.95437], [-39.66698,-72.95205], [-39.66690,-72.95055],
  [-39.66467,-72.95136], [-39.66386,-72.95940], [-39.66402,-72.95511], [-39.66264,-72.95575],
  [-39.66228,-72.95862], [-39.66083,-72.94925]],
  A: [[-39.66740,-72.95298], [-39.66666,-72.95730], [-39.66743,-72.95146], [-39.66685,-72.95024],
  [-39.66413,-72.95142], [-39.66514,-72.96088], [-39.66377,-72.95601], [-39.66262,-72.95627],
  [-39.66175,-72.95919], [-39.66102,-72.95055]],
  B: [[-39.66835,-72.95293], [-39.66624,-72.95599], [-39.66834,-72.95126], [-39.66771,-72.94972],
  [-39.66497,-72.95226], [-39.66462,-72.95827], [-39.66369,-72.95517], [-39.66282,-72.95589], 
  [-39.66234,-72.95760], [-39.66201,-72.94958]],
  C: [[-39.66893,-72.95288], [-39.66877,-72.95457], [-39.66902,-72.95177], [-39.66891,-72.94851],
  [-39.66504,-72.95107], [-39.66423,-72.95491], [-39.66305,-72.95560], [-39.66179,-72.95534]],
  D: [[-39.66947,-72.95283], [-39.66960,-72.95435], [-39.66617,-72.95058], [-39.66394,-72.95476],
  [-39.66330,-72.95532], [-39.66229,-72.95455]],
  E: [[-39.66995,-72.95330], [-39.66366,-72.95444], [-39.66255,-72.95548], [-39.65986,-72.95228]]
  }
  
  for (let item in markers) {
      for (let idx = 0; idx < markers[item].length; idx++) {
          if (item === 'num') {
              let pos = new L.LatLng(markers[item][idx][0],markers[item][idx][1]);
              let iconNum = (idx + 1);
              let icon = L.divIcon({
                  iconSize:null,
                  html:'<div class="map-label number"><div class="map-label-content">'+iconNum+'</div><div class="map-label-arrow"></div></div>'
                });
              L.marker(pos,{icon: icon}).addTo(map);
          } else {
            let pos = new L.LatLng(markers[item][idx][0],markers[item][idx][1]);
            let icon = L.divIcon({
              iconSize:null,
              html:'<div class="map-label square"><div class="map-label-content">'+item+'</div><div class="map-label-arrow"></div></div>'
            });
          L.marker(pos,{icon: icon}).addTo(map);
          }
      }
  }

// Enable device GPS
map.locate({watch: true, enableHighAccuracy: true, maximumAge: 2000});

// Add location marker
let gpsMarker = null;

function onLocationFound(e) {
  if (gpsMarker == null) {
    gpsMarker = L.marker(e.latlng).addTo(map);
  } else {
    gpsMarker.setLatLng(e.latlng);
  }
}

map.on('locationfound', onLocationFound);

// On location error
function onLocationError(e) {
  alert("No se pudo determinar su ubicación");
}

map.on('locationerror', onLocationError);